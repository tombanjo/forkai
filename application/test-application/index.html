<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Interface</title>
    <link rel="stylesheet" href="./styles.css">
  </head>
  <script type="module" src="./web-component/ai-chat-interface.js"></script>
  <body>
    <div class="app-container">
      <header class="app-header">
        <h1>AI Chat Assistant</h1>
      </header>
      
      <main class="app-main">
        <div class="chat-container">
          <div class="input-section">
            <label for="inputBox" class="input-label">Your Message</label>
            <textarea 
              id="inputBox" 
              placeholder="Type your message here..." 
              rows="6"
              class="message-input"
            ></textarea>
            <div class="button-group">
              <button id="submitButton" class="btn btn-primary">
                <span class="btn-text">Send</span>
                <span class="btn-icon">→</span>
              </button>
              <button id="clearButton" class="btn btn-secondary">Clear</button>
            </div>
          </div>
          
          <div id="outputBox" class="output-section">
            <div class="output-header">
              <h2>AI Response</h2>
            </div>
            <div class="ai-chat-output-content output-placeholder">
              <div class="placeholder-content">
                <svg class="placeholder-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <p>Your conversation will appear here</p>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
    <ai-chat-interface></ai-chat-interface>
    <script>
      const chatInterface = document.querySelector('ai-chat-interface');
      const inputBox = document.getElementById('inputBox');
      const submitButton = document.getElementById('submitButton');
      const clearButton = document.getElementById('clearButton');
      const outputBox = document.getElementById('outputBox');

      function showLoading() {
        outputBox.innerHTML = `
          <div class="output-header">
            <h2>AI Response</h2>
          </div>
          <div class="ai-chat-output-content">
            <div class="loading">Thinking...</div>
          </div>
        `;
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="btn-text">Sending</span><span class="btn-icon">⏳</span>';
      }

      function hideLoading() {
        submitButton.disabled = false;
        submitButton.innerHTML = '<span class="btn-text">Send</span><span class="btn-icon">→</span>';
      }

      function sendChat() {
        const data = inputBox.value.trim();
        if (data) {
          showLoading();
          chatInterface.data = { message: data };
        }
      }
      
      function clear() {
        inputBox.value = '';
        chatInterface.data = { message: '' };
        outputBox.innerHTML = `
          <div class="output-header">
            <h2>AI Response</h2>
          </div>
          <div class="ai-chat-output-content output-placeholder">
            <div class="placeholder-content">
              <svg class="placeholder-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              <p>Your conversation will appear here</p>
            </div>
          </div>
        `;
        hideLoading();
      }

      // Allow Enter to send (Shift+Enter for new line)
      inputBox.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendChat();
        }
      });

      submitButton.addEventListener('click', sendChat);
      clearButton.addEventListener('click', clear);

      chatInterface.addEventListener('message', (event) => {
        console.log('Message from AI:', event.detail);
        hideLoading();
        const { message, modelProvider } = event.detail;
        const markdownHtml = renderMarkdown(message);
        const providerLabel = modelProvider ? `<p class="model-provider">Powered by: ${modelProvider}</p>` : '';
        outputBox.innerHTML = `
          <div class="output-header">
            <h2>AI Response</h2>
          </div>
          <div class="ai-chat-output-content">${markdownHtml}${providerLabel}</div>
        `;
      });
      
      function renderMarkdown(text) {
        if (!text) return '';
        
        // Simple markdown parser for common patterns
        let html = text
          // Escape HTML first
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          // Headers
          .replace(/^### (.*$)/gim, '<h3>$1</h3>')
          .replace(/^## (.*$)/gim, '<h2>$1</h2>')
          .replace(/^# (.*$)/gim, '<h1>$1</h1>')
          // Bold
          .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
          .replace(/__(.+?)__/g, '<strong>$1</strong>')
          // Italic
          .replace(/\*(.+?)\*/g, '<em>$1</em>')
          .replace(/_(.+?)_/g, '<em>$1</em>')
          // Code blocks
          .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
          // Inline code
          .replace(/`(.+?)`/g, '<code>$1</code>')
          // Links
          .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
          // Line breaks
          .replace(/\n\n/g, '</p><p>')
          .replace(/\n/g, '<br>');
        
        // Wrap in paragraph if not already wrapped
        if (!html.startsWith('<h') && !html.startsWith('<pre') && !html.startsWith('<p>')) {
          html = '<p>' + html + '</p>';
        }
        
        return html;
      }

      chatInterface.addEventListener('error', (event) => {
        console.error('Error from AI:', event.detail);
        hideLoading();
        outputBox.innerHTML = `
          <div class="output-header">
            <h2>AI Response</h2>
          </div>
          <div class="ai-chat-output-content ai-chat-output-error">
            <strong>Error:</strong> ${event.detail || 'Failed to get response from AI'}
          </div>
        `;
      });
    </script>
  </body>
</html>